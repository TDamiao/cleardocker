#!/usr/bin/env bash
###############################################################################
# cleanup-all.sh â€“ Full cleanup + weekly auto-scheduling in cron
# Usage: sudo ./cleanup-all.sh
###############################################################################
set -euo pipefail
IFS=$'\n\t'

# Formatting functions
blue()  { printf "\033[1;34m%s\033[0m\n" "$*"; }
green() { printf "\033[1;32m%s\033[0m\n" "$*"; }
separator() {
  echo -e "\n=============================="
  blue  "$1"
  echo   "=============================="
}

# Ensures execution as root
[[ $EUID -ne 0 ]] && { echo "âš ï¸  Please run as root (sudo)."; exit 1; }

# Absolute path to this script
SCRIPT_PATH="$(readlink -f "$0")"

# 1. Auto-scheduling in cron (only on first run)
CRON_LINE="0 3 * * 1 $SCRIPT_PATH >> /var/log/cleanup.log 2>&1"
if crontab -l 2>/dev/null | grep -F "$SCRIPT_PATH" >/dev/null; then
  separator "â±ï¸ Cron already configured"
else
  (crontab -l 2>/dev/null; echo "$CRON_LINE") | crontab -
  separator "âœ… Scheduled: every Monday at 03:00"
fi

# Start timer
START=$(date +%s)

# 2. Disk usage before
separator "ğŸ“Š Disk usage BEFORE"
df -hT | awk 'NR==1 || /\/dev\/sda1/'

# 3. APT â€“ cache, orphan packages
separator "ğŸ§¹ APT â€“ cache & orphans"
CACHE_BEFORE=$(du -sh /var/cache/apt 2>/dev/null | cut -f1)
apt-get clean
apt-get autoclean -y
apt-get autoremove --purge -y
CACHE_AFTER=$(du -sh /var/cache/apt 2>/dev/null | cut -f1)
echo "âœ APT Cache: $CACHE_BEFORE â†’ $CACHE_AFTER"

# 4. Old kernels
separator "ğŸ§¹ Removing old kernels"
CURRENT=$(uname -r)
for K in $(dpkg -l 'linux-image-*' | awk '/^ii/{print $2}' | grep -v "$CURRENT"); do
  echo "âœ Removing $K"
  apt-get purge -y "$K" || true
done
command -v update-grub &>/dev/null && update-grub

# 5. Journald
separator "ğŸ§¹ Trimming systemd logs (200 MB)"
journalctl --vacuum-size=200M

# 6. /tmp and /var/tmp
separator "ğŸ§¹ Cleaning /tmp and /var/tmp"
find /tmp /var/tmp -mindepth 1 -maxdepth 1 -exec rm -rf {} +

# 7. Orphan libraries (deborphan)
separator "ğŸ§¹ Orphan libraries"
command -v deborphan &>/dev/null || apt-get install -y deborphan
deborphan | xargs --no-run-if-empty apt-get purge -y

# 8. Snap / Flatpak
separator "ğŸ§¹ Snap & Flatpak"
if command -v snap &>/dev/null; then
  snap list --all | awk '/disabled/{print $1,$3}' | \
    while read name rev; do snap remove "$name" --revision="$rev"; done || true
fi
command -v flatpak &>/dev/null && flatpak uninstall -y --unused || true

# 9. User Caches
separator "ğŸ§¹ Cleaning user caches"
for dir in /home/*; do
  if [ -d "$dir/.cache" ]; then
    echo "âœ Cleaning cache for user $(basename $dir)"
    rm -rf "$dir/.cache/*"
  fi
done

# 10. Old Logs
separator "ğŸ§¹ Cleaning old logs"
find /var/log -type f -name "*.log.*" -delete
find /var/log -type f -name "*.gz" -delete
find /var/log -type f -name "*.1" -delete

# 11. Open â€œdeletedâ€ files
separator "ğŸ” Open deleted files"
command -v lsof &>/dev/null || apt-get install -y lsof
lsof +L1 | awk '{printf "â€¢ %s (%s bytes)\n",$9,$7}' | head -n20 || echo "Nothing found."

# 12. Docker cleanup
if command -v docker &>/dev/null; then
  separator "ğŸ³ Docker cleanup"
  echo -e "\nğŸ” Pruning stopped containersâ€¦";    docker container prune -f
  echo -e "\nğŸ§¼ Pruning unused imagesâ€¦";    docker image prune -a -f
  echo -e "\nğŸ§¹ Pruning orphan volumesâ€¦";        docker volume prune -f
  echo -e "\nğŸ“¦ Current state:";          docker system df
else
  separator "ğŸ³ Docker not found â€“ skipping"
fi

# 13. Summary and disk usage after
END=$(date +%s)
separator "âœ… Cleanup finished in $((END-START)) seconds"
green "ğŸ’¾ Disk usage AFTER:"
df -hT | awk 'NR==1 || /\/dev\/sda1/'

echo -e "\nğŸš€ Done! This script now runs every Monday at 03:00."